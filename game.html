<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Campus Defender ‚Äî Smooth & Sound</title>
<style>
html, body {
  height: 100%; 
  margin: 0; 
  font-family: Arial, Helvetica, sans-serif;
  background: linear-gradient(#e8f7ef, #dff0e2);
  display: flex; 
  align-items: center; 
  justify-content: center;
}
#wrap {
  width: 95%; 
  max-width: 900px; 
  text-align: center;
}
canvas {
  width: 100%; 
  height: auto; 
  border-radius: 12px;
  background: linear-gradient(to bottom, #f6fff7 70%, #dff2de);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  display: block; 
  margin: 0 auto;
  touch-action: none;
}
.hud {
  display: flex; 
  gap: 8px; 
  align-items: center; 
  justify-content: space-between; 
  margin-top: 10px;
}
.bar {
  flex: 1; 
  height: 14px; 
  background: #eee; 
  border-radius: 8px; 
  overflow: hidden; 
  border: 1px solid #d1d1d1;
}
.fill {
  height: 100%; 
  width: 100%; 
  background: linear-gradient(90deg, #66bb6a, #2e7d32); 
  transition: width .25s;
}
button {
  background: #2e7d32; 
  color: white; 
  border: none; 
  padding: 8px 12px; 
  border-radius: 8px; 
  font-weight: 700; 
  cursor: pointer;
  flex-shrink: 0; /* Prevent button from shrinking */
}
#msg {
  margin-top: 10px; 
  color: #1b421f; 
  font-weight: 700; 
  min-height: 20px;
}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" width="960" height="540"></canvas>
  <div class="hud">
    <div class="bar"><div id="hp" class="fill"></div></div>
    <div style="display: flex; gap: 8px;">
      <button id="pauseBtn">Pause</button>
      <button id="restartBtn">Restart</button>
    </div>
  </div>
  <div id="msg">Tap canvas once to start. Swipe on mobile or use ‚Üê ‚Üí on keyboard.</div>
</div>

<script>
(() => {
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const hpEl = document.getElementById('hp');
const msgEl = document.getElementById('msg');
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');

const LOG_W = 960;
const LOG_H = 540;

function resizeCanvas() {
  const clientW = Math.min(window.innerWidth - 24, LOG_W);
  const scale = clientW / LOG_W;
  canvas.style.width = Math.round(LOG_W * scale) + 'px';
  canvas.style.height = Math.round(LOG_H * scale) + 'px';
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.round(LOG_W * dpr);
  canvas.height = Math.round(LOG_H * dpr);
  ctx.setTransform(dpr * scale, 0, 0, dpr * scale, 0, 0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

let running = false;
let paused = false;
let score = 0;
let health = 100;
let level = 1;

const player = {
  x: LOG_W / 2 - 28,
  y: LOG_H - 110,
  w: 56,
  h: 56,
  vx: 0,
  ax: 0,
  maxSpeed: 9
};

let items = [];
const healthy = ['üçè','üçé','üçá','üçâ'];
const harmful = ['üç≠','üç¨','üçî','üçï'];

let audioCtx = null;
function ensureAudio() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    try { audioCtx = new AC(); } catch(e) { audioCtx = null; }
  }
}
function playGood() {
  if (!audioCtx) { ensureAudio(); if (!audioCtx) return; }
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine'; o.frequency.value = 880;
  g.gain.value = 0.02;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + 0.09);
}
function playBad() {
  if (!audioCtx) { ensureAudio(); if (!audioCtx) return; }
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'triangle'; o.frequency.value = 200;
  g.gain.value = 0.035;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + 0.14);
}
function playGameOver() {
  if (!audioCtx) { ensureAudio(); if (!audioCtx) return; }
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sawtooth'; o.frequency.value = 140;
  g.gain.value = 0.04;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + 0.25);
}

function spawnItem() {
  const goodChance = Math.max(0.25, 0.75 - (level - 1) * 0.08);
  const isGood = Math.random() < goodChance;
  const emoji = isGood ? healthy[Math.floor(Math.random()*healthy.length)]
                       : harmful[Math.floor(Math.random()*harmful.length)];
  const size = 40 + Math.random()*28;
  items.push({
    x: Math.random() * (LOG_W - size) + size/2,
    y: -size,
    r: size/2,
    size: size,
    vy: 1.2 + Math.random()*1.8 + level*0.15,
    rot: (Math.random()-0.5)*0.04,
    wob: Math.random()*Math.PI*2,
    good: isGood,
    emoji: emoji
  });
}

function roundRect(c, x, y, w, h, r) {
  c.beginPath();
  c.moveTo(x + r, y);
  c.arcTo(x + w, y, x + w, y + h, r);
  c.arcTo(x + w, y + h, x, y + h, r);
  c.arcTo(x, y + h, x, y, r);
  c.arcTo(x, y, x + w, y, r);
  c.closePath();
}

function drawBackground(t) {
  const g = ctx.createLinearGradient(0, 0, 0, LOG_H);
  g.addColorStop(0, '#f2fbff');
  g.addColorStop(0.7, '#f7fff7');
  g.addColorStop(1, '#e8f6ea');
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, LOG_W, LOG_H);

  ctx.fillStyle = 'rgba(8,20,16,0.04)';
  for (let i = 0; i < 7; i++) {
    const bx = i * 130 + 20;
    const bh = 30 + (i % 3) * 22;
    ctx.fillRect(bx, LOG_H - 100 - bh, 80, bh);
  }

  const offset = (t * 0.03) % (LOG_W + 200);
  ctx.fillStyle = 'rgba(255,255,255,0.85)';
  roundRect(ctx, -80 + offset, 50, 160, 28, 14); ctx.fill();
  roundRect(ctx, -240 + offset, 80, 220, 28, 14); ctx.fill();
}

function drawPlayer() {
  ctx.fillStyle = 'rgba(8,16,12,0.06)';
  ctx.beginPath();
  ctx.ellipse(player.x + player.w / 2, player.y + player.h + 12, player.w * 0.7, 10, 0, 0, Math.PI * 2);
  ctx.fill();

  ctx.font = (player.w - 6) + 'px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillStyle = '#0d4d2e';
  ctx.fillText('üëæ', player.x + player.w / 2, player.y + player.h / 2 + 2);
}

function drawItems() {
  for (let o of items) {
    o.wob += 0.04;
    const wob = Math.sin(o.wob) * 6;
    ctx.save();
    ctx.translate(o.x + wob, o.y);
    ctx.rotate(o.rot);
    ctx.font = Math.round(o.size) + 'px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(o.emoji, 0, 0);
    ctx.restore();
  }
}

function rectCircleCollide(rx, ry, rw, rh, cx, cy, cr) {
  const cxCl = Math.max(rx, Math.min(cx, rx + rw));
  const cyCl = Math.max(ry, Math.min(cy, ry + rh));
  const dx = cx - cxCl;
  const dy = cy - cyCl;
  return (dx * dx + dy * dy) < (cr * cr);
}

let lastT = performance.now();
function update(t) {
  if (!running || paused) { lastT = t; return; }
  const dt = Math.min(40, t - lastT) / 16.6667; // scale per frame (approx)
  lastT = t;

  player.vx += player.ax * 1.0 * dt;
  player.vx *= 0.88; // friction
  if (Math.abs(player.vx) > player.maxSpeed) player.vx = player.maxSpeed * Math.sign(player.vx);
  player.x += player.vx * dt;

  if (player.x < 8) player.x = 8;
  if (player.x + player.w > LOG_W - 8) player.x = LOG_W - player.w - 8;

  if (Math.random() < 0.028 + (level - 1) * 0.002) spawnItem();

  for (let i = items.length - 1; i >= 0; i--) {
    const o = items[i];
    o.y += o.vy * dt;
    o.rot += (Math.random() - 0.5) * 0.01 * dt;
    if (rectCircleCollide(player.x, player.y, player.w, player.h, o.x, o.y, o.r)) {
      if (o.good) {
        score += 12;
        playGood();
      } else {
        health -= 18;
        playBad();
      }
      items.splice(i, 1);
      continue;
    }
    if (o.y > LOG_H + 80) items.splice(i, 1);
  }

  if (score >= level * 150) {
    level++;
    health = Math.min(100, health + 12);
    msgEl.textContent = 'Level ' + level + ' ‚Äî Keep choosing health.';
    paused = true;
    setTimeout(() => { msgEl.textContent = ''; paused = false; }, 1400);
  }

  if (health <= 0) {
    health = 0;
    running = false;
    msgEl.textContent = 'Game Over ‚Äî Stay Drug-Free';
    playGameOver();
  }

  hpEl.style.width = Math.max(0, health) + '%';
}

function draw(t) {
  ctx.clearRect(0, 0, LOG_W, LOG_H);
  drawBackground(t);
  drawItems();
  drawPlayer();

  ctx.fillStyle = '#184a1f';
  ctx.font = '18px Arial';
  ctx.textAlign = 'left';
  ctx.fillText('Score: ' + score, 16, 28);
  ctx.textAlign = 'right';
  ctx.fillText('Level: ' + level, LOG_W - 16, 28);
}

function loop(t) {
  update(t);
  draw(t);
  requestAnimationFrame(loop);
}

window.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') { player.ax = -0.9; ensureAudio(); running = true; msgEl.textContent = ''; }
  if (e.key === 'ArrowRight') { player.ax = 0.9; ensureAudio(); running = true; msgEl.textContent = ''; }
  if (e.key === ' ') { ensureAudio(); running = true; msgEl.textContent = ''; }
});
window.addEventListener('keyup', (e) => {
  if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') player.ax = 0;
});

let touchStartX = null;
canvas.addEventListener('touchstart', (ev) => {
  if (ev.touches && ev.touches.length === 1) {
    touchStartX = ev.touches[0].clientX;
  }
  ensureAudio(); running = true; msgEl.textContent = '';
}, { passive: true });

canvas.addEventListener('touchmove', (ev) => {
  if (!touchStartX || !ev.touches || ev.touches.length !== 1) return;
  const touchX = ev.touches[0].clientX;
  const dx = touchX - touchStartX;
  // Convert screen dx to logical dx (approx)
  const screenW = canvas.getBoundingClientRect().width;
  const scale = screenW / LOG_W;
  player.x += dx / scale;
  touchStartX = touchX;
}, { passive: true });

canvas.addEventListener('touchend', () => { touchStartX = null; });

pauseBtn.addEventListener('click', () => {
  paused = !paused;
  pauseBtn.textContent = paused ? '‚ñ∂ Resume' : '‚ùö‚ùö Pause';
  if (!paused && health > 0) running = true;
});

restartBtn.addEventListener('click', () => {
  resetGame();
});

function resetGame() {
  items = [];
  score = 0;
  health = 100;
  level = 1;
  player.x = LOG_W / 2 - player.w / 2;
  player.vx = 0;
  player.ax = 0;
  running = true;
  paused = false;
  hpEl.style.width = '100%';
  msgEl.textContent = 'Collect healthy items ‚Äî avoid drugs!';
  pauseBtn.textContent = 'Pause';
}

resetGame();
requestAnimationFrame(loop);
})();
</script>
</body>
</html>